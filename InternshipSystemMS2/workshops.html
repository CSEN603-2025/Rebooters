<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshops - GUC Internship System</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="header-content">
            <h1>GUC Internship System</h1>
            <div class="nav">
                <button onclick="window.location.href='dashboard.html'">Dashboard</button>
                <button onclick="window.location.href='video-call.html'">Appointments</button>
                <button onclick="window.location.href='workshops.html'" class="active">Workshops</button>
                <button onclick="window.location.href='assessments.html'">Assessments</button>
                <button onclick="logout()">Logout</button>
            </div>
            <span id="userInfo"></span>
        </div>
    </header>

    <div class="container">
        <div id="accessCheck"></div>
        <div id="workshopContent" style="display:none;">
            <div class="workshop-tabs">
                <button class="tab-button active" onclick="switchTab('upcoming')">Upcoming Workshops</button>
                <button class="tab-button" onclick="switchTab('registered')">My Registrations</button>
            </div>

            <div class="workshop-filters">
                <input type="text" id="searchWorkshop" placeholder="Search workshops...">
                <select id="categoryFilter">
                    <option value="">All Categories</option>
                    <option value="technical">Technical</option>
                    <option value="soft-skills">Soft Skills</option>
                    <option value="career">Career Development</option>
                    <option value="industry">Industry Specific</option>
                </select>
                <select id="typeFilter">
                    <option value="">All Types</option>
                    <option value="live">Live Workshops</option>
                    <option value="pre-recorded">Pre-recorded Workshops</option>
                </select>
            </div>

            <div id="workshopList" class="workshop-grid"></div>
        </div>
    </div>

    <!-- Workshop View Modal -->
    <div id="workshopModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle"></h3>
                <button onclick="closeModal()" class="close-button">&times;</button>
            </div>
            <div id="modalContent">
                <!-- Workshop content will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Live Workshop View -->
    <div id="liveWorkshopView" class="modal">
        <div class="modal-content workshop-view">
            <div class="modal-header">
                <h3 id="workshopTitle"></h3>
                <button onclick="completeWorkshop()" class="close-button">&times;</button>
            </div>
            <div class="workshop-layout">
                <div class="video-section">
                    <video id="workshopVideo" controls>
                        Your browser does not support the video element.
                    </video>
                    <div class="video-controls" id="videoControls" style="display: none;">
                        <button onclick="if(workshopPlayer) workshopPlayer.play()">Play</button>
                        <button onclick="if(workshopPlayer) workshopPlayer.pause()">Pause</button>
                        <button onclick="if(workshopPlayer) workshopPlayer.stop()">Stop</button>
                    </div>
                </div>
                
                <div class="interaction-section">
                    <div class="notes-section">
                        <h4>My Notes</h4>
                        <div id="notesList"></div>
                        <textarea id="newNote" placeholder="Take notes..."></textarea>
                        <button onclick="saveNote()">Save Note</button>
                    </div>
                    
                    <div class="chat-section">
                        <h4>Live Chat</h4>
                        <div id="chatMessages"></div>
                        <div class="chat-input">
                            <input type="text" id="chatMessage" placeholder="Type your message..." oninput="updateChatPreview(event)">
                            <button onclick="sendChatMessage()">Send</button>
                        </div>
                        <div id="chatPreview" class="chat-preview"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Certificate View Modal -->
    <div id="certificateModal" class="modal">
        <div class="modal-content certificate">
            <div id="certificateContent"></div>
            <button onclick="downloadCertificate()">Download Certificate</button>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal">
        <div class="modal-content">
            <h3>Workshop Feedback</h3>
            <div class="rating-section">
                <div class="stars">
                    <span class="star" data-rating="1">★</span>
                    <span class="star" data-rating="2">★</span>
                    <span class="star" data-rating="3">★</span>
                    <span class="star" data-rating="4">★</span>
                    <span class="star" data-rating="5">★</span>
                </div>
                </div>
            <textarea id="feedbackText" placeholder="Share your thoughts about the workshop..."></textarea>
            <button onclick="submitFeedback()">Submit Feedback</button>
        </div>
    </div>

    <script src="workshops.js"></script>
    <script>
        let workshopManager;
        let currentWorkshop;
        let workshopPlayer;
        let currentRating = 0;

        document.addEventListener('DOMContentLoaded', function() {
            const workshopContent = document.getElementById('workshopContent');
            const accessCheck = document.getElementById('accessCheck');
            
            // Use the validation function from workshops.js
            if (!checkAndValidateProBadge()) {
                accessCheck.innerHTML = `
                    <div class="access-denied">
                        <h2>Access Denied</h2>
                        <p>You need to earn your PRO badge to access workshops. Complete 3 months of internships to earn your badge.</p>
                        <button onclick="window.location.href='dashboard.html'" class="btn-primary">Return to Dashboard</button>
                    </div>
                `;
                workshopContent.style.display = 'none';
                return;
            }

            // If PRO badge is valid, initialize workshop manager
            accessCheck.style.display = 'none';
            workshopContent.style.display = 'block';
            workshopManager = new WorkshopManager();
            renderWorkshops('upcoming');
            initializeFilters();

            // Initialize star rating
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', (e) => {
                    currentRating = parseInt(e.target.dataset.rating);
                    updateStarRating();
                });
            });
        });

        function logout() {
            localStorage.clear();
            window.location.href = "index.html";
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            event.target.classList.add('active');
            renderWorkshops(tab);
        }

        function renderWorkshops(tab) {
            const grid = document.getElementById('workshopList');
            let workshops = [];

            switch(tab) {
                case 'registered':
                    const registrations = workshopManager.getMyRegistrations();
                    workshops = registrations
                        .filter(reg => !reg.completed)
                        .map(reg => workshopManager.getWorkshopById(reg.workshopId));
                    break;
                default: // upcoming
                    workshops = workshopManager.workshops.filter(w => w.status === WorkshopStatus.UPCOMING);
                    break;
            }

            grid.innerHTML = workshops.map(workshop => `
                <div class="workshop-card ${workshop.type}">
                    <div class="workshop-header">
                        <h3>${workshop.title}</h3>
                        <span class="workshop-type">${workshop.type === WorkshopType.LIVE ? 'Live Workshop' : 'Pre-recorded'}</span>
                    </div>
                    <p class="description">${workshop.description}</p>
                    <div class="workshop-details">
                        <p><strong>Date:</strong> ${new Date(workshop.date).toLocaleDateString()}</p>
                        <p><strong>Time:</strong> ${workshop.time}</p>
                        <p><strong>Duration:</strong> ${workshop.duration}</p>
                        <p><strong>Instructor:</strong> ${workshop.instructor}</p>
                        ${tab === 'upcoming' ? `<p><strong>Available Spots:</strong> ${workshop.capacity - workshop.registered}</p>` : ''}
                    </div>
                    ${getWorkshopActions(workshop, tab)}
                </div>
            `).join('');
        }

        function getWorkshopActions(workshop, tab) {
            if (tab === 'registered') {
                const now = new Date();
                const workshopDate = new Date(workshop.date + ' ' + workshop.time);
                
                if (now >= workshopDate) {
                    // Workshop is currently available to attend
                    return `
                        <div class="workshop-actions">
                            ${workshop.type === WorkshopType.LIVE ? 
                                `<button onclick="joinLiveWorkshop(${workshop.id})" class="primary-btn">Join Live Session</button>` :
                                `<button onclick="watchRecording(${workshop.id})" class="primary-btn">Watch Recording</button>`
                            }
                        </div>
                    `;
                } else {
                    // Workshop hasn't started yet
                    return `
                        <div class="workshop-actions">
                            <button disabled>Starts on ${new Date(workshop.date).toLocaleDateString()} at ${workshop.time}</button>
                        </div>
                    `;
                }
            }

            // Default case (upcoming workshops tab)
            return `
                <div class="workshop-actions">
                    <button onclick="registerForWorkshop(${workshop.id})" 
                            ${workshop.capacity <= workshop.registered ? 'disabled' : ''}>
                        ${workshop.capacity <= workshop.registered ? 'Workshop Full' : 'Register Now'}
                    </button>
                </div>
            `;
        }

        function registerForWorkshop(workshopId) {
            try {
                workshopManager.registerForWorkshop(workshopId);
                workshopManager.sendNotification('Successfully registered for the workshop!');
                switchTab('registered'); // Switch to registered workshops tab
            } catch (error) {
                workshopManager.sendNotification(error.message);
            }
        }

        function joinLiveWorkshop(workshopId) {
            currentWorkshop = workshopManager.getWorkshopById(workshopId);
            const liveView = document.getElementById('liveWorkshopView');
            
            // Initialize video player
            const video = document.getElementById('workshopVideo');
            video.src = currentWorkshop.videoUrl;
            workshopPlayer = workshopManager.initializeVideoPlayer(video, workshopId);

            // Hide video controls for live workshops
            document.getElementById('videoControls').style.display = 'none';

            // Show chat for live workshops
            const chatSection = document.querySelector('.chat-section');
            if (currentWorkshop.type === WorkshopType.LIVE) {
                chatSection.style.display = 'flex';
                
                // Initialize chat
                const chat = workshopManager.initializeChat(workshopId);
                if (chat) {
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = ''; // Clear previous messages
                    
                    chat.subscribe(message => {
                        chatMessages.innerHTML += `
                            <div class="chat-message ${message.userEmail === localStorage.getItem('userEmail') ? 'own-message' : ''}">
                                <strong>${message.userEmail}:</strong> ${message.content}
                                <span class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</span>
                            </div>
                        `;
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    });

                    // Setup chat input handlers
                    const chatInput = document.getElementById('chatMessage');
                    const sendButton = document.querySelector('.chat-input button');
                    
                    // Send message on enter key
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            sendChatMessage();
                        }
                    });

                    // Send message on button click
                    sendButton.addEventListener('click', sendChatMessage);
                }
            } else {
                chatSection.style.display = 'none';
            }

            // Show the live view modal
            liveView.style.display = 'block';
        }

        function watchRecording(workshopId) {
            currentWorkshop = workshopManager.getWorkshopById(workshopId);
            const liveView = document.getElementById('liveWorkshopView');
            
            // Initialize video player
            const video = document.getElementById('workshopVideo');
            video.src = currentWorkshop.videoUrl;
            workshopPlayer = workshopManager.initializeVideoPlayer(video, workshopId);

            // Show video controls for pre-recorded workshops
            document.getElementById('videoControls').style.display = 'flex';

            // Hide chat section for recordings
            document.querySelector('.chat-section').style.display = 'none';
            
            // Show the video view modal
            liveView.style.display = 'block';
        }

        function viewNotes(workshopId) {
            const notes = workshopManager.getNotes(workshopId);
            const workshop = workshopManager.getWorkshopById(workshopId);

            const modal = document.getElementById('workshopModal');
            document.getElementById('modalTitle').textContent = `Notes - ${workshop.title}`;
            document.getElementById('modalContent').innerHTML = `
                <div class="notes-section standalone">
                    <div id="notesList">
                        ${notes.map(note => `
                            <div class="note">
                                <p>${note.content}</p>
                                <span class="note-time">${new Date(note.timestamp).toLocaleString()}</span>
                            </div>
                        `).join('') || '<p>No notes taken yet.</p>'}
                    </div>
                    <textarea id="newNote" placeholder="Take notes..."></textarea>
                    <button onclick="saveNote(${workshopId})">Save Note</button>
                </div>
            `;
            modal.style.display = 'block';
        }

        function viewMaterials(workshopId) {
            const workshop = workshopManager.getWorkshopById(workshopId);
            const modal = document.getElementById('workshopModal');
            document.getElementById('modalTitle').textContent = `Workshop Materials - ${workshop.title}`;
            document.getElementById('modalContent').innerHTML = `
                <div class="materials-list">
                    <h4>Available Materials:</h4>
                    <ul>
                        ${workshop.materials.map(material => `
                            <li>${material}</li>
                        `).join('')}
                    </ul>
                </div>
            `;
            modal.style.display = 'block';
        }

        function renderNotes(workshopId) {
            const notes = workshopManager.getNotes(workshopId);
            const notesList = document.getElementById('notesList');
            notesList.innerHTML = notes.map(note => `
                <div class="note">
                    <p>${note.content}</p>
                    <span class="note-time">${new Date(note.timestamp).toLocaleString()}</span>
                </div>
            `).join('');
        }

        function saveNote() {
            const noteText = document.getElementById('newNote').value.trim();
            if (noteText && currentWorkshop) {
                workshopManager.saveNote(currentWorkshop.id, noteText);
                document.getElementById('newNote').value = '';
                renderNotes(currentWorkshop.id);
            }
        }

        function updateChatPreview(event) {
            const previewText = event.target.value.trim();
            const chatPreview = document.getElementById('chatPreview');
            if (previewText) {
                chatPreview.innerHTML = `
                    <div class="chat-message own-message preview">
                        <strong>You:</strong> ${previewText}
                        <span class="message-time">${new Date().toLocaleTimeString()}</span>
                    </div>
                `;
                chatPreview.style.display = 'block';
            } else {
                chatPreview.style.display = 'none';
            }
        }

        function sendChatMessage() {
            const messageInput = document.getElementById('chatMessage');
            const message = messageInput.value.trim();
            if (message && currentWorkshop) {
                const chat = workshopManager.initializeChat(currentWorkshop.id);
                if (chat) {
                    chat.sendMessage(message);
                    messageInput.value = '';
                    // Clear the preview after sending
                    document.getElementById('chatPreview').style.display = 'none';
                }
            }
        }

        function viewCertificate(workshopId) {
            const certificate = workshopManager.generateCertificate(workshopId);
            if (certificate) {
                const modal = document.getElementById('certificateModal');
                document.getElementById('certificateContent').innerHTML = `
                    <div class="certificate-content">
                        <h2>Certificate of Completion</h2>
                        <p>This is to certify that</p>
                        <h3>${certificate.recipientName}</h3>
                        <p>has successfully completed the workshop</p>
                        <h3>${certificate.workshopTitle}</h3>
                        <p>on ${certificate.completionDate}</p>
                        <p>Instructor: ${certificate.instructor}</p>
                        <p class="certificate-id">Certificate ID: ${certificate.certificateId}</p>
                    </div>
                `;
                modal.style.display = 'block';
            }
        }

        function openFeedback(workshopId) {
            currentWorkshop = workshopManager.getWorkshopById(workshopId);
            document.getElementById('feedbackModal').style.display = 'block';
        }

        function submitFeedback() {
            if (currentWorkshop && currentRating > 0) {
                const feedbackText = document.getElementById('feedbackText').value.trim();
                workshopManager.submitFeedback(currentWorkshop.id, currentRating, feedbackText);
                
                // Close feedback modal
                document.getElementById('feedbackModal').style.display = 'none';
                
                // Show success message
                workshopManager.sendNotification('Thank you for your feedback! Your certificate has been saved.');
                
                // Refresh the workshops list
                renderWorkshops('completed');
            } else {
                workshopManager.sendNotification('Please provide a rating before submitting feedback.');
            }
        }

        function updateStarRating() {
            document.querySelectorAll('.star').forEach(star => {
                const rating = parseInt(star.dataset.rating);
                star.classList.toggle('active', rating <= currentRating);
            });
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal();
            }
        }

        function initializeFilters() {
            const searchWorkshop = document.getElementById('searchWorkshop');
            const categoryFilter = document.getElementById('categoryFilter');
            const typeFilter = document.getElementById('typeFilter');

            const filterWorkshops = () => {
                const searchTerm = searchWorkshop.value.toLowerCase();
                const category = categoryFilter.value;
                const type = typeFilter.value;

                let filteredWorkshops = workshopManager.workshops;

                if (searchTerm) {
                    filteredWorkshops = filteredWorkshops.filter(w => 
                        w.title.toLowerCase().includes(searchTerm) || 
                        w.description.toLowerCase().includes(searchTerm)
                    );
                }

                if (category) {
                    filteredWorkshops = filteredWorkshops.filter(w => w.category === category);
                }

                if (type) {
                    filteredWorkshops = filteredWorkshops.filter(w => w.type === type);
                }

                const grid = document.getElementById('workshopList');
                grid.innerHTML = filteredWorkshops.map(workshop => `
                    <div class="workshop-card ${workshop.type}">
                        <div class="workshop-header">
                            <h3>${workshop.title}</h3>
                            <span class="workshop-type">${workshop.type === WorkshopType.LIVE ? 'Live Workshop' : 'Pre-recorded'}</span>
                        </div>
                        <p class="description">${workshop.description}</p>
                        <div class="workshop-details">
                            <p><strong>Date:</strong> ${new Date(workshop.date).toLocaleDateString()}</p>
                            <p><strong>Time:</strong> ${workshop.time}</p>
                            <p><strong>Duration:</strong> ${workshop.duration}</p>
                            <p><strong>Instructor:</strong> ${workshop.instructor}</p>
                            <p><strong>Available Spots:</strong> ${workshop.capacity - workshop.registered}</p>
                        </div>
                        ${getWorkshopActions(workshop, 'upcoming')}
                    </div>
                `).join('');
            };

            searchWorkshop.addEventListener('input', filterWorkshops);
            categoryFilter.addEventListener('change', filterWorkshops);
            typeFilter.addEventListener('change', filterWorkshops);
        }

        function completeWorkshop() {
            if (currentWorkshop) {
                // Generate and show certificate
                const certificate = workshopManager.generateCertificate(currentWorkshop.id);
                if (certificate) {
                    const certificateModal = document.getElementById('certificateModal');
                    document.getElementById('certificateContent').innerHTML = `
                        <div class="certificate-content">
                            <h2>Certificate of Completion</h2>
                            <p>This is to certify that</p>
                            <h3>${certificate.recipientName}</h3>
                            <p>has successfully completed the workshop</p>
                            <h3>${certificate.workshopTitle}</h3>
                            <p>on ${certificate.completionDate}</p>
                            <p>Instructor: ${certificate.instructor}</p>
                            <p class="certificate-id">Certificate ID: ${certificate.certificateId}</p>
                        </div>
                        <button onclick="document.getElementById('certificateModal').style.display='none';document.getElementById('feedbackModal').style.display='block';" class="primary-btn">Continue to Feedback</button>
                    `;
                    certificateModal.style.display = 'block';
                }
                
                // Close workshop view
                document.getElementById('liveWorkshopView').style.display = 'none';
            }
        }
    </script>
</body>
</html>